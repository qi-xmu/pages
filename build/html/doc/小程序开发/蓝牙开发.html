<!DOCTYPE html>
<html class="writer-html5" lang="zh" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>小程序开发-蓝牙使用 &mdash; Dacazh 0.1 文档</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="AR 养花" href="../%E6%83%B3%E6%B3%95%E9%9A%8F%E7%AC%94/AR%E5%85%BB%E8%8A%B1.html" />
    <link rel="prev" title="中期报告" href="../%E5%A4%A7%E5%88%9B%E7%9B%B8%E5%85%B3/%E4%B8%AD%E6%9C%9F%E6%8A%A5%E5%91%8A.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> Dacazh
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">ALL:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../1.%E9%A1%B9%E7%9B%AE%E8%AE%A1%E5%88%92/Typora%E5%90%8C%E6%AD%A5%E8%AE%A1%E5%88%92.html">Typora同步计划</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1.%E9%A1%B9%E7%9B%AE%E8%AE%A1%E5%88%92/%E6%B5%8B%E8%AF%95Typora%E5%90%8C%E6%AD%A5Gitee.html">This is a Test</a></li>
<li class="toctree-l1"><a class="reference internal" href="../API%E6%90%AD%E5%BB%BA%E5%92%8C%E4%BD%BF%E7%94%A8%E7%BB%8F%E9%AA%8C/HTTP%28s%29API%E7%BB%8F%E9%AA%8C%E6%80%BB%E7%BB%93.html">HTTP(s) API 经验总结</a></li>
<li class="toctree-l1"><a class="reference internal" href="../API%E6%90%AD%E5%BB%BA%E5%92%8C%E4%BD%BF%E7%94%A8%E7%BB%8F%E9%AA%8C/README.html">说明</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Flutter/flutter%E6%9E%84%E5%BB%BAwin%E5%BA%94%E7%94%A8.html">Flutter 构建windows应用</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Python%E7%9B%B8%E5%85%B3/Conda.html">Conda使用指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Rust%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/README.html">说明</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Rust%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/Rust%E7%AC%AC%E4%B8%80%E5%A4%A9.html">学习Rust第一天 Rust语言特点</a></li>
<li class="toctree-l1"><a class="reference internal" href="../WSL2/wsl2%E8%BF%9E%E6%8E%A5usb.html">使用WSL2连接USB设备</a></li>
<li class="toctree-l1"><a class="reference internal" href="../%E5%A4%A7%E5%88%9B%E7%9B%B8%E5%85%B3/%E4%B8%AD%E6%9C%9F%E6%8A%A5%E5%91%8A.html">中期报告</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">小程序开发-蓝牙使用</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id2">参考文献</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id3">使用方法</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id4">检查蓝牙状态</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">搜索设备</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id6">连接设备</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id7">查询服务</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id">查询特征值ID</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id8">监控接收信息</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id9">发送信息</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id10">完整代码</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../%E6%83%B3%E6%B3%95%E9%9A%8F%E7%AC%94/AR%E5%85%BB%E8%8A%B1.html">AR 养花</a></li>
<li class="toctree-l1"><a class="reference internal" href="../%E6%83%B3%E6%B3%95%E9%9A%8F%E7%AC%94/%E6%96%B0%E7%9A%842021.html">告别2020，迎接2021</a></li>
<li class="toctree-l1"><a class="reference internal" href="../%E7%89%A9%E8%81%94%E7%BD%91%E7%9B%B8%E5%85%B3/GY91%28MPU9250%20%2B%20BMP280%29%E6%83%AF%E6%80%A7%E4%BC%A0%E6%84%9F%E5%99%A8%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97_bcpjxgjik1WoVfNY5fbpT8.html">GY91(MPU9250 + BMP280)惯性传感器开发指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../%E7%A8%8B%E5%BA%8F%E8%B0%83%E8%AF%95%E6%8A%80%E5%B7%A7/GDB%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97.html">GDB调试记录</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API搭建和使用经验:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../API%E6%90%AD%E5%BB%BA%E5%92%8C%E4%BD%BF%E7%94%A8%E7%BB%8F%E9%AA%8C/HTTP%28s%29API%E7%BB%8F%E9%AA%8C%E6%80%BB%E7%BB%93.html">HTTP(s) API 经验总结</a></li>
<li class="toctree-l1"><a class="reference internal" href="../API%E6%90%AD%E5%BB%BA%E5%92%8C%E4%BD%BF%E7%94%A8%E7%BB%8F%E9%AA%8C/README.html">说明</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">项目计划:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../1.%E9%A1%B9%E7%9B%AE%E8%AE%A1%E5%88%92/Typora%E5%90%8C%E6%AD%A5%E8%AE%A1%E5%88%92.html">Typora同步计划</a></li>
<li class="toctree-l1"><a class="reference internal" href="../1.%E9%A1%B9%E7%9B%AE%E8%AE%A1%E5%88%92/%E6%B5%8B%E8%AF%95Typora%E5%90%8C%E6%AD%A5Gitee.html">This is a Test</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Dacazh</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>小程序开发-蓝牙使用</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/doc/小程序开发/蓝牙开发.md.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="id1">
<h1>小程序开发-蓝牙使用<a class="headerlink" href="#id1" title="永久链接至标题"></a></h1>
<p>[TOC]</p>
<section id="id2">
<h2>参考文献<a class="headerlink" href="#id2" title="永久链接至标题"></a></h2>
<p><a class="reference external" href="https://uniapp.dcloud.io/api/system/bluetooth">蓝牙 - uni-app官网 (dcloud.io)</a></p>
<p><a class="reference external" href="https://uniapp.dcloud.io/api/system/ble?id=writeblecharacteristicvalue">低功耗蓝牙 - uni-app官网 (dcloud.io)</a></p>
<p><a class="reference external" href="https://blog.csdn.net/yqlnihao/article/details/119455845">小程序连蓝牙，发送数据_yqlnihao的博客-CSDN博客</a></p>
<p><a class="reference external" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/DataView/setUint8">DataView.prototype.setUint8() - JavaScript | MDN (mozilla.org)</a></p>
<p><a class="reference external" href="https://www.cnblogs.com/weiqinl/p/10575727.html">js中ASCII码和字符互相转换的方法 - weiqinl - 博客园 (cnblogs.com)</a></p>
</section>
<section id="id3">
<h2>使用方法<a class="headerlink" href="#id3" title="永久链接至标题"></a></h2>
<section id="id4">
<h3>检查蓝牙状态<a class="headerlink" href="#id4" title="永久链接至标题"></a></h3>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">uni</span><span class="p">.</span><span class="nx">openBluetoothAdapter</span><span class="p">();</span>
</pre></div>
</div>
</section>
<section id="id5">
<h3>搜索设备<a class="headerlink" href="#id5" title="永久链接至标题"></a></h3>
<p>开始搜索</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">uni</span><span class="p">.</span><span class="nx">startBluetoothDevicesDiscovery</span><span class="p">()</span>
</pre></div>
</div>
<p>绑定回调，一旦发现新设备执行。这一步可以筛选出自己需要连接的设备进行连接。</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">uni</span><span class="p">.</span><span class="nx">onBluetoothDeviceFound</span><span class="p">()</span>
</pre></div>
</div>
<p>搜索返回信息如下</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;deviceId&quot;</span><span class="p">:</span> <span class="s2">&quot;98:DA:20:00:AA:3C&quot;</span><span class="p">,</span>
  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;WuYin-V1&quot;</span><span class="p">,</span>
  <span class="nt">&quot;RSSI&quot;</span><span class="p">:</span> <span class="mi">-62</span><span class="p">,</span>
  <span class="nt">&quot;localName&quot;</span><span class="p">:</span> <span class="s2">&quot;WuYin-V1\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000&quot;</span><span class="p">,</span>
  <span class="nt">&quot;advertisServiceUUIDs&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;00004353-0000-1000-8000-00805F9B34FB&quot;</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id6">
<h3>连接设备<a class="headerlink" href="#id6" title="永久链接至标题"></a></h3>
<p>连接设备，这一步需要已知设备的<code class="docutils literal notranslate"><span class="pre">deviceId</span></code>，通过搜索结果可以得到这个值。连接成功后需要停止搜索</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">uni</span><span class="p">.</span><span class="nx">createBLEConnection</span><span class="p">()</span>
<span class="nx">uni</span><span class="p">.</span><span class="nx">stopBluetoothDevicesDiscovery</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="id7">
<h3>查询服务<a class="headerlink" href="#id7" title="永久链接至标题"></a></h3>
<p>在成功连接后延时一秒执行，查询服务列表，获取服务的<code class="docutils literal notranslate"><span class="pre">uuid</span></code></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">uni</span><span class="p">.</span><span class="nx">getBLEDeviceServices</span><span class="p">()</span> <span class="c1">// 查询服务列表</span>
</pre></div>
</div>
<p>服务列表示例如下，不同服务的权限是不同的。通过测试，这里使用的是最后一个服务，其服务的<code class="docutils literal notranslate"><span class="pre">uuid=0000FFE0-0000-1000-8000-00805F9B34FB</span></code>。</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;services&quot;</span><span class="p">:</span> <span class="p">[{</span>
    <span class="nt">&quot;uuid&quot;</span><span class="p">:</span> <span class="s2">&quot;00001800-0000-1000-8000-00805F9B34FB&quot;</span><span class="p">,</span>
    <span class="nt">&quot;isPrimary&quot;</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">},</span> <span class="p">{</span>
    <span class="nt">&quot;uuid&quot;</span><span class="p">:</span> <span class="s2">&quot;00001801-0000-1000-8000-00805F9B34FB&quot;</span><span class="p">,</span>
    <span class="nt">&quot;isPrimary&quot;</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">},</span> <span class="p">{</span>
    <span class="nt">&quot;uuid&quot;</span><span class="p">:</span> <span class="s2">&quot;0000180A-0000-1000-8000-00805F9B34FB&quot;</span><span class="p">,</span>
    <span class="nt">&quot;isPrimary&quot;</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">},</span> <span class="p">{</span>
    <span class="nt">&quot;uuid&quot;</span><span class="p">:</span> <span class="s2">&quot;0000FFE0-0000-1000-8000-00805F9B34FB&quot;</span><span class="p">,</span>
    <span class="nt">&quot;isPrimary&quot;</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">}],</span>
  <span class="nt">&quot;errMsg&quot;</span><span class="p">:</span> <span class="s2">&quot;getBLEDeviceServices:ok&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id">
<h3>查询特征值ID<a class="headerlink" href="#id" title="永久链接至标题"></a></h3>
<p>通过服务查询该服务的特征值权限（需要<code class="docutils literal notranslate"><span class="pre">devieceId</span></code>和<code class="docutils literal notranslate"><span class="pre">serviceId</span></code>），一个服务可以有短多个特征值，特征值的权限有<code class="docutils literal notranslate"><span class="pre">read</span></code> <code class="docutils literal notranslate"><span class="pre">write</span></code> <code class="docutils literal notranslate"><span class="pre">notify</span></code> <code class="docutils literal notranslate"><span class="pre">indicate</span></code>。一般使用<code class="docutils literal notranslate"><span class="pre">write</span></code>（向蓝牙发送信息）和<code class="docutils literal notranslate"><span class="pre">notify</span></code>（监控蓝牙发送的信息并回调）。</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">uni</span><span class="p">.</span><span class="nx">getBLEDeviceCharacteristics</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">[{</span>
  <span class="nt">&quot;uuid&quot;</span><span class="p">:</span> <span class="s2">&quot;0000FFE1-0000-1000-8000-00805F9B34FB&quot;</span><span class="p">,</span>
  <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;read&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nt">&quot;write&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nt">&quot;notify&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;indicate&quot;</span><span class="p">:</span> <span class="kc">false</span>
  <span class="p">}</span>
<span class="p">},</span> <span class="p">{</span>
  <span class="nt">&quot;uuid&quot;</span><span class="p">:</span> <span class="s2">&quot;0000FFE2-0000-1000-8000-00805F9B34FB&quot;</span><span class="p">,</span>
  <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;read&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nt">&quot;write&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nt">&quot;notify&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nt">&quot;indicate&quot;</span><span class="p">:</span> <span class="kc">false</span>
  <span class="p">}</span>
<span class="p">}]</span>
</pre></div>
</div>
</section>
<section id="id8">
<h3>监控接收信息<a class="headerlink" href="#id8" title="永久链接至标题"></a></h3>
<p>启动<code class="docutils literal notranslate"><span class="pre">notify</span></code>功能，监控蓝牙发送的信息。需要传入<code class="docutils literal notranslate"><span class="pre">state</span></code> <code class="docutils literal notranslate"><span class="pre">deviceId</span></code> <code class="docutils literal notranslate"><span class="pre">serviceId</span></code> <code class="docutils literal notranslate"><span class="pre">characteristicId</span></code>。其中<code class="docutils literal notranslate"><span class="pre">state</span></code>状态为<code class="docutils literal notranslate"><span class="pre">true</span></code>则打开该服务。</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">uni</span><span class="p">.</span><span class="nx">notifyBLECharacteristicValueChange</span><span class="p">()</span>
</pre></div>
</div>
<p>传入回调函数，当收到蓝牙信息时被调用。</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">uni</span><span class="p">.</span><span class="nx">onBLECharacteristicValueChange</span><span class="p">()</span>
</pre></div>
</div>
<p>接收的信息为<code class="docutils literal notranslate"><span class="pre">Arraybuffer</span></code>，需要先转成16进制，再转成字符串。</p>
<p><a class="reference external" href="https://www.cnblogs.com/weiqinl/p/10575727.html">js中ASCII码和字符互相转换的方法 - weiqinl - 博客园 (cnblogs.com)</a></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="cm">/* buffer转16进制 */</span>
<span class="kd">function</span> <span class="nx">ab2hex</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">hexArr</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">map</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span>
    <span class="ow">new</span> <span class="nb">Uint8Array</span><span class="p">(</span><span class="nx">buffer</span><span class="p">),</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">bit</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;00&#39;</span> <span class="o">+</span> <span class="nx">bit</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mf">16</span><span class="p">)).</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="mf">2</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">)</span>
  <span class="k">return</span> <span class="nx">hexArr</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
<span class="p">}</span>
<span class="cm">/* 16进制转字符串 */</span>
<span class="kd">function</span> <span class="nx">hextoString</span><span class="p">(</span><span class="nx">hex</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nx">hex</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">arr</span><span class="p">)</span>
  <span class="kd">var</span> <span class="nx">out</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mf">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">tmp</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="s2">&quot;0x&quot;</span> <span class="o">+</span> <span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
    <span class="kd">var</span> <span class="nx">charValue</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCodePoint</span><span class="p">(</span><span class="nx">tmp</span><span class="p">)</span>
    <span class="nx">out</span> <span class="o">+=</span> <span class="nx">charValue</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="id9">
<h3>发送信息<a class="headerlink" href="#id9" title="永久链接至标题"></a></h3>
<p>发送信息，需要将信息转成<code class="docutils literal notranslate"><span class="pre">Arraybuffer</span></code>的类型。</p>
<p><a class="reference external" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/DataView/setUint8">DataView.prototype.setUint8() - JavaScript | MDN (mozilla.org)</a></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">stringtoHex</span><span class="p">(</span><span class="nx">str</span><span class="p">){</span>
	<span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
	<span class="kd">const</span> <span class="nx">buffer</span> <span class="o">=</span> <span class="ow">new</span> <span class="nb">ArrayBuffer</span><span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
	<span class="kd">const</span> <span class="nx">dataView</span> <span class="o">=</span> <span class="ow">new</span> <span class="nb">DataView</span><span class="p">(</span><span class="nx">buffer</span><span class="p">)</span>
	<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">str</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
	<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="ow">in</span> <span class="nx">arr</span><span class="p">){</span>
		<span class="kd">var</span> <span class="nx">num</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">charCodeAt</span><span class="p">()</span>
		<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">num</span><span class="p">)</span>
		<span class="nx">dataView</span><span class="p">.</span><span class="nx">setUint8</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="nx">num</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">buffer</span>
<span class="p">}</span>
</pre></div>
</div>
<p>发送信息函数</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">uni</span><span class="p">.</span><span class="nx">writeBLECharacteristicValue</span><span class="p">({</span>
  <span class="c1">// 这里的 deviceId 需要在 getBluetoothDevices 或 onBluetoothDeviceFound 接口中获取</span>
  <span class="nx">deviceId</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">deviceId</span><span class="p">,</span>
  <span class="c1">// 这里的 serviceId 需要在 getBLEDeviceServices 接口中获取</span>
  <span class="nx">serviceId</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">services</span><span class="p">[</span><span class="mf">3</span><span class="p">].</span><span class="nx">uuid</span><span class="p">,</span>
  <span class="c1">// 这里的 characteristicId 需要在 getBLEDeviceCharacteristics 接口中获取</span>
  <span class="nx">characteristicId</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">charactersRead</span><span class="p">,</span>
  <span class="c1">// 这里的value是ArrayBuffer类型</span>
  <span class="nx">value</span><span class="o">:</span> <span class="nx">stringtoHex</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">value</span><span class="p">),</span>
  <span class="nx">success</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;writeBLECharacteristicValue success&#39;</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">errMsg</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div>
</div>
</section>
</section>
<section id="id10">
<h2>完整代码<a class="headerlink" href="#id10" title="永久链接至标题"></a></h2>
<div class="highlight-vue notranslate"><div class="highlight"><pre><span></span>&lt;template&gt;
  &lt;view class=&quot;u-margin-20 &quot;&gt;
    &lt;!-- 连接状态指示 --&gt;
    &lt;view class=&quot;u-margin-20 u-flex u-row-center&quot;&gt;
      &lt;view class=&quot;u-margin-right-10&quot;&gt;
        &lt;text style=&quot;font-weight: bold;&quot;&gt;连接状态(点击标签连接):&lt;/text&gt;
      &lt;/view&gt;
      &lt;u-tag v-if=&quot;!searching &amp; !connected&quot; text=&quot;未连接&quot; @click=&quot;connect_dev&quot; type=&quot;error&quot; /&gt;
      &lt;view v-else-if=&quot;searching &amp; !connected&quot;&gt;
        &lt;u-tag  text=&quot;正在连接&quot; type=&quot;warning&quot;&gt;&lt;/u-tag&gt;
        &lt;u-loading class=&quot;u-margin-left-10&quot; mode=&quot;circle&quot;&gt;&lt;/u-loading&gt;
      &lt;/view&gt;
      &lt;u-tag v-else text=&quot;已连接&quot; type=&quot;success&quot; /&gt;
    &lt;/view&gt;
    &lt;!-- 信息发送框 --&gt;
    &lt;view id=&quot;base&quot; class=&quot;list u-padding-20 u-flex-col&quot;&gt;
      &lt;u-input v-model=&quot;value&quot; type=&quot;text&quot; :border=&quot;true&quot; /&gt;
      &lt;u-button class=&quot;u-margin-20&quot; type=&quot;primary&quot; @click=&quot;test_send&quot;&gt;发送&lt;/u-button&gt;
    &lt;/view&gt;

  &lt;/view&gt;
&lt;/template&gt;

&lt;script&gt;
  /* buffer转16进制 */
  function ab2hex(buffer) {
    const hexArr = Array.prototype.map.call(
      new Uint8Array(buffer),
      function(bit) {
        return (&#39;00&#39; + bit.toString(16)).slice(-2)
      }
    )
    return hexArr.join(&#39; &#39;)
  }
  /* 16进制转字符串 */
  function hextoString(hex) {
    var arr = hex.split(&#39; &#39;)
    console.log(arr)
    var out = &quot;&quot;
    for (var i = 0; i &lt; arr.length; i++) {
      var tmp = Number(&quot;0x&quot; + arr[i])
      var charValue = String.fromCodePoint(tmp)
      out += charValue
    }
    return out
  }
  /* 字符串转成可发送的buffer */
  function stringtoHex(str){
    var arr = str.split(&#39;&#39;)
    const buffer = new ArrayBuffer(str.length)
    const dataView = new DataView(buffer)
    
    console.log(arr, str.length)
    for(var i in arr){
      var num = arr[i].charCodeAt()
      console.log(num)
      dataView.setUint8(i,num)
    }
    return buffer
  }

  export default {
    data() {
      return {
        value: &quot;&quot;,
        searching: false,
        connected: false,
        deviceId: &quot;&quot;,
        services: [],
        charactersWrite: &quot;&quot;,
        charactersNotify: &quot;&quot;,
      }
    },
    methods: {
      test_send() {
        console.log(this.value);
        if (this.connected == false) {
          uni.showToast({
            title: &quot;请连接设备&quot;,
            icon: &quot;none&quot;
          })
        } else {
          uni.writeBLECharacteristicValue({
            // 这里的 deviceId 需要在 getBluetoothDevices 或 onBluetoothDeviceFound 接口中获取
            deviceId: this.deviceId,
            // 这里的 serviceId 需要在 getBLEDeviceServices 接口中获取
            serviceId: this.services[3].uuid,
            // 这里的 characteristicId 需要在 getBLEDeviceCharacteristics 接口中获取
            characteristicId: this.charactersRead,
            // 这里的value是ArrayBuffer类型
            value: stringtoHex(this.value),
            success(res) {
              console.log(&#39;writeBLECharacteristicValue success&#39;, res.errMsg)
            }
          });
        }
      },
      open_blu() {
        uni.openBluetoothAdapter({
          success(res) {
            console.log(res.errMsg)
          }
        });
      },
      connect_dev() {
        var self = this
        console.log(&quot;search..&quot;)
        this.searching = true;
        // 连接
        uni.startBluetoothDevicesDiscovery({
          success(res) {
            // 搜索连接设备 
            uni.onBluetoothDeviceFound(function(res) {
              if (res.devices[0].name == &quot;WuYin-V1&quot;) {
                console.log(res.devices[0]);
                // 这里的 deviceId 需要已经通过 createBLEConnection 与对应设备建立链接
                self.deviceId = res.devices[0].deviceId
                uni.createBLEConnection({
                  deviceId: self.deviceId,
                  success(res) {
                    console.log(res)
                    self.stop_search()
                    self.bind_notify()
                  }
                });
              }
            });
          }
        })
      },
      stop_search() {
        console.log(&quot;stop..&quot;)
        uni.stopBluetoothDevicesDiscovery({
          success(res) {
            console.log(res)
          }
        });
      },
      bind_notify() {
        setTimeout(() =&gt; {
          uni.getBLEDeviceServices({
            // 这里的 deviceId 需要已经通过 createBLEConnection 与对应设备建立链接
            deviceId: this.deviceId,
            success: (res) =&gt; {
              // console.log(&quot;成功&quot;,res)
              console.log(&#39;device services:&#39;, res)
              this.services = res.services
              uni.getBLEDeviceCharacteristics({
                deviceId: this.deviceId,
                serviceId: this.services[3].uuid,
                success: (res) =&gt; {
                  this.charactersNotify = res.characteristics[0].uuid
                  this.charactersRead = res.characteristics[1].uuid
                  console.log(res.characteristics)
                }
              });
            }
          });
        }, 1000);
        setTimeout(() =&gt; {
          console.log(&quot;deviceID&quot;, this.deviceId)
          console.log(&quot;Service&quot;, this.services[3].uuid)
          console.log(&quot;Notify&quot;, this.charactersNotify)
          console.log(&quot;Read&quot;, this.charactersRead)
          uni.notifyBLECharacteristicValueChange({
            state: true, // 启用 notify 功能
            // 这里的 deviceId 需要已经通过 createBLEConnection 与对应设备建立链接
            deviceId: this.deviceId,
            // 这里的 serviceId 需要在 getBLEDeviceServices 接口中获取
            serviceId: this.services[3].uuid,
            // 这里的 characteristicId 需要在 getBLEDeviceCharacteristics 接口中获取
            characteristicId: this.charactersNotify,
            success(res) {
              console.log(&#39;notifyBLECharacteristicValueChange success&#39;, res.errMsg)
              self.connected = true
              self.searching = false
              uni.showToast({
                title: &quot;连接成功&quot;
              });
              /* 绑定回调 */
              uni.onBLECharacteristicValueChange(function(res) {
                console.log(`characteristic ${res.characteristicId} has changed`)
                console.log(res)
                /* 这个是接收的信息，为十六进制 */
                console.log(ab2hex(res.value))
                console.log(hextoString(ab2hex(res.value)))
              });
            }
          });
        }, 1500);
      }
    },
    onShow() {
      // 检测蓝牙是否开启 
      this.open_blu()
    }
  }
&lt;/script&gt;

&lt;style&gt;
&lt;/style&gt;
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../%E5%A4%A7%E5%88%9B%E7%9B%B8%E5%85%B3/%E4%B8%AD%E6%9C%9F%E6%8A%A5%E5%91%8A.html" class="btn btn-neutral float-left" title="中期报告" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="../%E6%83%B3%E6%B3%95%E9%9A%8F%E7%AC%94/AR%E5%85%BB%E8%8A%B1.html" class="btn btn-neutral float-right" title="AR 养花" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2022, Qi.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用了 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a>开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>